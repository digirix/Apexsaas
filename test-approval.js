import fetch from 'node-fetch';

// Function to test the approval process
async function testApproval() {
  try {
    // 1. Get auto-generated tasks by using our debug endpoint
    console.log("1. Getting auto-generated tasks...");
    const tasksResponse = await fetch("http://localhost:5000/api/v1/debug/tasks");
    
    const tasksData = await tasksResponse.json();
    const tasks = tasksData.autoGeneratedTasks;
    console.log(`Found ${Array.isArray(tasks) ? tasks.length : 0} auto-generated tasks`);
    
    if (Array.isArray(tasks) && tasks.length > 0) {
      // 2. Pick a task to approve
      const taskToApprove = tasks[0];
      console.log(`\n2. Selected task ${taskToApprove.id} for approval`);
      console.log(`Task flags before: isAutoGenerated=${taskToApprove.isAutoGenerated}, isRecurring=${taskToApprove.isRecurring}, needsApproval=${taskToApprove.needsApproval}`);
      
      // 3. Use our debug approval endpoint to test the fixed implementation
      console.log(`\n3. Testing approval of task ${taskToApprove.id}...`);
      const approvalResponse = await fetch(`http://localhost:5000/api/v1/debug/test-approval/${taskToApprove.id}`);
      
      const result = await approvalResponse.json();
      console.log(`\nApproval test results:`);
      console.log(`Success: ${result.success}`);
      console.log(`Task count before: ${result.beforeCount}, after: ${result.afterCount}`);
      console.log(`\nTask before approval:`);
      console.log(result.taskBefore);
      console.log(`\nTask after approval:`);
      console.log(result.taskAfter);
      console.log(`\nParent task before approval:`);
      console.log(result.parentBefore);
      console.log(`\nParent task after approval:`);
      console.log(result.parentAfter);
      
      if (result.beforeCount === result.afterCount) {
        console.log("\n✓ SUCCESS: No new tasks were created during approval!");
      } else {
        console.log(`\n❌ ERROR: Tasks count changed from ${result.beforeCount} to ${result.afterCount}`);
      }
      
      if (result.taskAfter && 
          result.taskAfter.isAutoGenerated === false && 
          result.taskAfter.isRecurring === true && 
          result.taskAfter.needsApproval === false) {
        console.log("✓ SUCCESS: Task flags were updated correctly!");
      } else {
        console.log("❌ ERROR: Task flags were not updated as expected");
      }
      
      if (result.parentAfter && result.parentAfter.isRecurring === false) {
        console.log("✓ SUCCESS: Parent task isRecurring flag was set to false!");
      } else {
        console.log("❌ ERROR: Parent task isRecurring flag was not set to false");
      }
    } else {
      console.log("No auto-generated tasks found to approve");
    }
  } catch (error) {
    console.error("Error testing approval:", error);
  }
}

// Run the test
testApproval();
